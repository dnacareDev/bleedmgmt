<!doctype html>
<html lang="en" dir="ltr"
      xmlns:th="http://www.thymeleaf.org">

<head>

    <!-- 공통 헤더 -->
    <th:block th:include="/../fragments/header.html"></th:block>

    <style>

        #doughnut .slick-slider__single {
            background: #FFFFFF;
            height: 270px;
            justify-content: space-between;
        }

        .main-content .contents .row .card { /* 2021-10-19 AlpaDesign 추가 */
            border-radius: 10px;
            box-shadow: 0 3px 15px 3px rgb(0 0 0 / 7%); /* 2021-11-02 수정 */
            /* box-shadow: 0 0 3px 3px rgb(0 0 0/ 3%); */
        }

        .slick-slider__single.d-flex {
            display: block !important;
            width: 100% !important;
        }

        .main-content .contents .row .card .slick-slider__single { /* 2021-10-19 AlpaDesign 추가 */
            align-items: start;
        }

        .main-content .contents .row .card .data_percent {
            font-size: 11px;
            display: table;
            height: 100%;
            text-align: right;
        }

        .main-content .contents .row .card .data_percent ul {
            display: table-cell;
            vertical-align: middle;
            line-height: 1.89;
        }

        .slick-slider.slick-dots-bottom .slick-dots {
            margin: 0 0 5px;
        }

        .main-content .contents .slick-slider .slick-dots li.slick-active button {
            background-color: #3B7366;
        }

        .main-content .contents .slick-slider .slick-dots li {
            width: 30px;
            padding: 0;
            margin-left: 10px;
        }

        .main-content .contents .slick-slider .slick-dots li:first-child {
            margin-left: 0;
        }

        .main-content .contents .slick-slider .slick-dots li button {
            width: 100%;
        }

        .main-content .contents .color-primary {
            color: #222222;
        }

        .main-content .col-lg-12 .card .card-body ul.map li {
            float: left;
            width: calc((100% - 50px) / 2);
            margin-left: 50px;
            overflow: hidden;
        }

        .main-content .col-lg-12 .card .card-body ul.map li:first-child {
            margin-left: 0;
        }

        .main-content .card-body ul.map li img {
            width: 100%;
        }

        .data_relative {
            position: relative;
        }

        .data_number {
            position: absolute;
            left: 25%;
            top: 46%;
        }

        #google_container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            height: 200px;
        }

        #google_container li {
            flex: 1;
            height: 100%;
        }

        .main-content .contents .container-fluid {
            max-width: 100%;
            padding-top: 30px;
        }


        /* 2021 - 11 - 01 수정 */
        .main-content .contents .row .card .card-body #doughnut.slick-slider {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .container-fluid .col-lg-12 .card .card-body {
            padding: 10px 1.56rem 10px;
        }

        .main-content .contents .container-fluid {
            padding-top: 15px
        }

        .col-lg-12 .card .card-body .slick-slider__single {
            width: 50%
        }

        .col-lg-12 .card .card-body .slick-slider__single .color-primary {
            margin: 10px -70px 0 0 !important;
            white-space: nowrap;
        }

        .col-lg-12 .card .card-body .slick-slider__single .data_percent {
            margin-right: 58px;
        }

        .col-lg-12 .card .card-body .slick-slider__single:last-child .data_percent:last-child {
            margin-right: 0px;
        }

        .container-fluid:last-child .col-lg-12 .card .card-body {
            padding-bottom: 40px
        }

        /* 두변쨰 카드 */
        .container-fluid .col-lg-12 .card .color-primary {
            margin-top: 2rem !important;
            margin-bottom: 0 !important;
            margin-left: 2rem !important;
            font-size: 18px;
        }

        .col-lg-12 .card .card-body #google_container {
            height: 400px
        }

        /* 2021 - 11 - 02 수정 */
        .footer-wrapper, .container-fluid, .col-lg-12 {
            background-color: #FCFCFC;
        }


        @media only screen and (min-width: 992px) {
            /* 2021-10-19 AlpaDesign 추가 */
            .main-content .contents .row .col-lg-12 {
                padding: 0 50px 0 50px;
            }

            .main-content .contents .row .col-lg-8 {
                padding: 0 10px 0 50px;
            }

            .main-content .contents .row .col-lg-4 {
                padding: 0 50px 0 10px;
            }

        }

        .labels {
            width: 100%;
            text-align: right;
        }

        .labels.right_content_la {
            text-align: left;
            padding: 0 33px;
        }

        .labels li {
            display: inline-block;
            margin-left: 10px;
            cursor: pointer;
        }

        .labels li:first-child {
            margin-left: 0;
        }

        .labels li span[class*="dought_"] {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
        }

        .labels li span[class*="blue"] {
            background-color: #6AB7FF;
        }

        .labels li span[class*="green"] {
            background-color: #63D9B6;
        }

        .labels li span[class*="orange"] {
            background-color: #FBAD55;
        }

        .main-content #CropSelect, .main-content #selectMonthlyYearly, .main-content #selectYear {
            margin-top: -40px !important;
        }
    </style>
</head>

<body class="layout-light top-menu overlayScroll">
<div class="mobile-search"></div>

<div class="mobile-author-actions"></div>

<!-- 공통 topbar -->
<th:block th:include="/../fragments/topbar.html"></th:block>

<main class="main-content" style="background-color: #FCFCFC;">

    <div class="contents" style="background-color: #FFFFFF;">

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                    	<p class="color-primary fa-lg mb-3 mt-5 ml-3">자원관리 현황</p>
                        <div class="card-body" style="height: 350px;">
                            <div id="doughnut" class="slick-slider slick-dots-bottom" data-dots-slick='true'>
                                <div class="slick-slider__single d-flex">
                                    <select class="form-control form-control-lg mt-10 mb-10 mr-10" style="width: 250px; float: right;" name="selectCrop" id="CropSelect">
                                        <th:block th:each="list : ${cropList}">
                                            <option th:value="${list.crop_id}" th:text="${list.crop_name}"></option>
                                        </th:block>
                                    </select>
                                    
                                    <select class="form-control form-control-lg mt-10 mb-10 mr-10" style="width: 250px; float: right;" name="selectYear" id="selectYear">
                                        <!--  <option value="2022" selected>2022</option> -->
                                    </select>
                                    
                                    <div class="data_relative">
                                        <div class="doughnut_cover">
                                            <canvas id="bar1" style="height: 300px; width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <p class="color-primary fa-lg mb-3 mt-5 ml-3">작물별 자원관리</p>
                        <div class="card-body" style="height: auto;">
                            <div>
                                <canvas id="bar2" style="height: 350px; width:100%"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	

</main>

<!-- 공통 하단 -->
<th:block th:include="/../fragments/footer.html"></th:block>
<!-- 공통 js -->
<th:block th:include="/../fragments/commonjs.html"></th:block>

<script type="text/javascript">  

    $(document).ready(function () {
        $(".selector li").click(function (e) {
            let id = this.innerText;
            let el = document.getElementById(id);

            (el.checked == true) ? el.checked = false : el.checked = true;
        });
    });

    $(document).ready(function () {
    	addYear();
    	SelectMonth();
        SelectCrop();
        SelectFile();
        
        
    });

    $("#CropSelect").change(function () {
        bar1.reset();

        SelectMonth();
        /*
        if($("#selectMonthlyYearly option:selected").val() == 'monthly') {
    		SelectMonth();
    	} else {
    		SelectYear();
    	}
        */
    });
    
    $("#selectYear").change(function () {
    	bar1.reset();
    	
    	SelectMonth();
    });
    
    function addYear() {
    	let currentTime = new Date();
    	let thisYear = currentTime.getFullYear()
    	//console.log(thisYear);
    	
    	for(let i=thisYear ; i>=2022 ; i--) {
	    	$("#selectYear").append("<option value=" + i + ">" + i +"</option>");
    	}
    }
    
    /*
    $("#selectMonthlyYearly").change(function () {
    	bar1.reset();
    	
    	if($("#selectMonthlyYearly option:selected").val() == 'monthly') {
    		SelectMonth();
    	} else {
    		SelectYear();
    	}
    	
    });

    var bar1 = null;

    
    // 2022-07-05 | 작업중. 더기반 chart.js 참고해서 올해가 제일 오른쪽에 출력될 수 있도록 작업
    function SelectYear() {
    	
        var crop_id = $("#CropSelect").val();

        var data = {"crop_id": crop_id}

        $.ajax({
            url: 'selectYear',
            method: 'POST',
            dataType: 'json',
            data: data,
            success: function (result) {
            	console.log("year result : ", result);
            	
            	var date = new Date();
                var year = date.getYear() + 1896
                var year_list = [];
            	
            	
            	
                var label = []

                for (let i = 0; i < result.resourceList.length; i++) {
                    label.push(result.resourceList[i].resource_name);
                }

                var data = []

                for (let i = 0; i < result.count.length; i++) {
                    data.push(result.count[i]);
                }

                var ctx1 = document.getElementById("bar1");

                let currentDate = new Date();
                let currentYear = currentDate.getFullYear();
                
                var config1 = {
                    type: 'bar',
                    data: {
                        //labels: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
                        labels: [(currentYear-4)+"년", (currentYear-3)+"년", (currentYear-2)+"년", (currentYear-1)+"년", currentYear+"년"],
                        datasets: [],
                        stackSeries: true,
                    },
                    options: {
                        responsive: false,
                        scales: {
                            xAxes: [{
                                barPercentage: 0.5
                            }],
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true,
                                    stepSize: 10,
                                }
                            }],
                        },
                        legend: {
                            display: true,
                            position: "left",
                            labels: {
                                usePointStyle: true,
                            },
                        },
                    }
                };
				
                var color1 = 29;
                var color2 = 51;
                var color3 = 137;
                
				for (let i = 0; i < label.length; i++) {
                   
	               	color1 += 33;
	                   color2 += 67;
	                   color3 += 89;
	               	
	               	if(color1 > 200) {
	                   	color1 -= 200;
	                   }
	               	
	               	if(color2 > 200) {
	                   	color2 -= 150;
	                   }
	               	
	               	if(color3 > 200) {
	                   	color3 -= 130;
	                   }

	                var dataset = {
	                    label: label[i],
	                    data: data[i],
	                    backgroundColor: 'rgb(' + color1 + ', ' + color2 + ', ' + color3 + ')',
	                    //stack: 'Stack 0',
	                    //stackSeries: true
	                }
	                
	                config1.data.datasets.push(dataset);
	                //console.log("config1",config1);
	                //console.log("config1.data.datasets", config1.data.datasets);
                   
				}
                
                bar1 = new Chart(ctx1, config1);
                
            }
        })
    }
    */
    
    function SelectMonth() {
        var crop_id = $("#CropSelect").val();
        let year = $("#selectYear option:selected").val();
        
        console.log("year : ",year);

        var data = {"crop_id": crop_id, "year": year}

        $.ajax({
            url: 'selectMonth',
            method: 'POST',
            dataType: 'json',
            data: data,
            success: function (result) {
            	
            	console.log("month result : ", result);
            	
                var label = []

                for (let i = 0; i < result.resourceList.length; i++) {
                    label.push(result.resourceList[i].resource_name);
                }

                var data = []

                for (let i = 0; i < result.count.length; i++) {
                    data.push(result.count[i]);
                }

                var ctx1 = document.getElementById("bar1");

                var config1 = {
                    type: 'bar',
                    data: {
                        labels: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
                        datasets: [],
                        stackSeries: true,
                    },
                    options: {
                        responsive: true,
                        scales: {
                            xAxes: [{
                                barPercentage: 0.5
                            }],
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true,
                                    stepSize: 10,
                                }
                            }],
                        },
                        legend: {
                            display: true,
                            position: "left",
                            labels: {
                                usePointStyle: true,
                            },
                        },
                    }
                };
				
                var color1 = 29;
                var color2 = 51;
                var color3 = 137;
                
				for (let i = 0; i < label.length; i++) {
                   
	               	color1 += 33;
	                   color2 += 67;
	                   color3 += 89;
	               	
	               	if(color1 > 200) {
	                   	color1 -= 200;
	                   }
	               	
	               	if(color2 > 200) {
	                   	color2 -= 150;
	                   }
	               	
	               	if(color3 > 200) {
	                   	color3 -= 130;
	                   }

	                var dataset = {
	                    label: label[i],
	                    data: data[i],
	                    backgroundColor: 'rgb(' + color1 + ', ' + color2 + ', ' + color3 + ')',
	                    //stack: 'Stack 0',
	                    //stackSeries: true
	                }
	                
	                config1.data.datasets.push(dataset);
	                //console.log("config1",config1);
	                //console.log("config1.data.datasets", config1.data.datasets);
                   
				}
                
                bar1 = new Chart(ctx1, config1);
            }
        })
    }

    function SelectCrop() {
    	
    	/*
    	// 작목별 관리현황에서 관리대장에 활성화된 작물만 차트목록에 노출시켜야 함
    	$.ajax({
            url: "search-resource2",
            method: "POST",
            dataType: "json",
            success: function (result) {
           		console.log("(home) searchResource2 result : ", result); 	
            }
    	});
    	*/
    	
        $.ajax({
            url: 'selectCrop',
            method: 'POST',
            dataType: 'json',
            data: data,
            success: function (result) {
            	
            	console.log("crop result : ", result);
            	
                var labels = []

                for (let i = 0; i < result.resourceList.length; i++) {
                    labels.push(result.resourceList[i].resource_name);
                }

                var label = [];

                for (let i = 0; i < result.cropList.length; i++) {
                    label.push(result.cropList[i].crop_name);
                }

                var count = [];

                for (let i = 0; i < result.count.length; i++) {
                    count.push(result.count[i]);
                }

                var ctx2 = document.getElementById("bar2");
                var config2 = {
                    type: 'horizontalBar',
                    data: {
                        labels: labels,
                        datasets: [],
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            xAxes: [{
                                ticks: {
                                    beginAtZero: true,
                                    stepSize: 1,
                                }
                            }]
                        },
                        legend: {
                            display: true,
                            position: "left",
                            labels: {
                                usePointStyle: true,
                            },
                        },
                    }
                };

                var bar2 = new Chart(ctx2, config2);

                var color1 = 89;
                var color2 = 51;
                var color3 = 137;
                
                for (let i = 0; i < label.length; i++) {
                    
                	color1 += 33;
                    color2 += 67;
                    color3 += 89;
                	
                	if(color1 > 200) {
                    	color1 -= 200;
                    }
                	
                	if(color2 > 200) {
                    	color2 -= 150;
                    }
                	
                	if(color3 > 200) {
                    	color3 -= 130;
                    }
                	
                	

                    var dataset = {
                        label: label[i],
                        data: count[i],
                        backgroundColor: 'rgb(' + color1 + ', ' + color2 + ', ' + color3 + ')',
                        //backgroundColor: 'rgb(255, 155, 147)',
                    }

                    config2.data.datasets.push(dataset);
                }
                
                console.log("config2 : ", config2);
                console.log("datasets : ", config2.datasets);

                bar2.update();
            }
        })
    }

    function SelectFile() {
        $.ajax({
            url: 'selectFile',
            method: 'POST',
            dataType: 'json',
            data: data,
            success: function (result) {
            	
                var chartData = [result.file.img_count, result.file.doc_count];

                var ctx3 = document.getElementById("bar3");

                var config3 = {
                    type: 'pie',
                    data: {
                        labels: ["사진", "문서"],
                        datasets: [
                            {
                                data: chartData,
                                backgroundColor: [
                                    'rgb(251, 173, 85)',
                                    'rgb(106, 183, 255)'
                                ],
                                borderWidth: 0, label: "Dataset 1"
                            }
                        ],
                    },
                    options: {
                        legend: {
                            position: "bottom",
                            labels: {
                                usePointStyle: true,
                            },
                        },
                    },
                };

                var bar3 = new Chart(ctx3, config3);
            }
        })
    }
    
    
</script>

</body>

</html>