<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.digitalresource.Mapper.BreedMapper">
    <insert id="insertBreed" useGeneratedKeys="true" keyProperty="breed_id">
    	insert into breed (resource_id, create_date, variety_name, breed_row)
    	select #{resource_id}, now(), (select crop_name from crop c inner join resource r on c.crop_id = r.crop_id where r.resource_id = #{resource_id}),(select ifnull(max(breed_row)+1,1) from breed where  resource_id = #{resource_id})
    </insert>

	<insert id="insertStandard" useGeneratedKeys="true" keyProperty="standard_id">
    	insert into standard (breed_id, detail_id, standard_data)
    	select #{breed_id}, (select d.detail_id from resource r inner join detail d on r.resource_id = d.resource_id where r.resource_id = ${resource_id} limit ${limit},1), #{standard_data}
    </insert>
    
    <update id="updateStandardCell" >
        UPDATE standard SET
        standard_data = #{standard_data} 
        WHERE standard_id = #{standard_id}
    </update>
    
    <select id="selectStandard" resultType="StandardList">
    	select s.standard_id,d.detail_id, s.standard_data, b.resource_id, b.breed_row from breed b 
		inner join standard s on b.breed_id = s.breed_id
		inner join detail d on s.detail_id = d.detail_id where b.resource_id = #{resource_id};
    </select>
    
    <select id="selectDetailCount" resultType="CountSelect">
    	select  max(detail_id) as max, min(detail_id) as min, count(detail_id) as count from detail where resource_id= #{resource_id};
    </select>
    
    <delete id="deleteStandard">
    	delete from standard 
        where standard_id 
        in(
        select  standard_id from
        (select standard_id from standard where breed_id in 
        (select breed_id from breed where breed_row in(${breed_id}))) a);
    </delete>
    
    <delete id="deleteBreed">
    	delete from breed 
    	where breed_id in (
    	select breed_id from (
    	select breed_id from breed where breed_row in(${breed_id})) a);
    </delete>
    
    <select id="selectResourceId" resultType="int">
    	select resource_id from resource where resource_name_id in (select resource_name_id from resource_name where resource_name = #{resource_name}) and crop_id = #{crop_id}
    </select>
</mapper>